#include "ns3/core-module.h"
#include "ns3/network-module.h"
#include "ns3/internet-module.h"
#include "ns3/point-to-point-module.h"
#include "ns3/applications-module.h"

using namespace ns3;

int main() {
  Time::SetResolution(Time::NS);

  // Create nodes
  NodeContainer users;
  users.Create(20);

  Ptr<Node> server = CreateObject<Node>();
  Ptr<Node> peer = CreateObject<Node>();
  Ptr<Node> drone = CreateObject<Node>();

  // Install Internet stack
  InternetStackHelper stack;
  stack.Install(users);
  stack.Install(server);
  stack.Install(peer);
  stack.Install(drone);

  // Point-to-point links between each user and the server
  PointToPointHelper p2p;
  p2p.SetDeviceAttribute("DataRate", StringValue("10Mbps"));
  p2p.SetChannelAttribute("Delay", StringValue("2ms"));

  Ipv4AddressHelper address;
  std::vector<Ipv4InterfaceContainer> userToServerIfaces;

  for (uint32_t i = 0; i < users.GetN(); ++i) {
    NodeContainer pair(users.Get(i), server);
    NetDeviceContainer devices = p2p.Install(pair);

    std::ostringstream subnet;
    subnet << "10.1." << i + 1 << ".0";
    address.SetBase(subnet.str().c_str(), "255.255.255.0");

    userToServerIfaces.push_back(address.Assign(devices));
  }

  // Connect each user to peer and drone
  Ipv4AddressHelper userToPeerAddr;
  Ipv4AddressHelper userToDroneAddr;

  for (uint32_t i = 0; i < users.GetN(); ++i) {
    // User to Peer
    NetDeviceContainer dev1 = p2p.Install(NodeContainer(users.Get(i), peer));
    std::ostringstream subnet1;
    subnet1 << "10.2." << i + 1 << ".0";
    userToPeerAddr.SetBase(subnet1.str().c_str(), "255.255.255.0");
    userToPeerAddr.Assign(dev1);

    // User to Drone
    NetDeviceContainer dev2 = p2p.Install(NodeContainer(users.Get(i), drone));
    std::ostringstream subnet2;
    subnet2 << "10.3." << i + 1 << ".0";
    userToDroneAddr.SetBase(subnet2.str().c_str(), "255.255.255.0");
    userToDroneAddr.Assign(dev2);
  }

  // Assign IP addresses and start echo applications
  UdpEchoServerHelper echoServer(9);
  ApplicationContainer serverApps = echoServer.Install(server);
  serverApps.Start(Seconds(1.0));
  serverApps.Stop(Seconds(10.0));

  for (uint32_t i = 0; i < users.GetN(); ++i) {
    UdpEchoClientHelper echoClient(userToServerIfaces[i].GetAddress(1), 9);
    echoClient.SetAttribute("MaxPackets", UintegerValue(1));
    echoClient.SetAttribute("Interval", TimeValue(Seconds(1.0)));
    echoClient.SetAttribute("PacketSize", UintegerValue(512));

    ApplicationContainer clientApps = echoClient.Install(users.Get(i));
    clientApps.Start(Seconds(2.0 + i * 0.1));
    clientApps.Stop(Seconds(10.0));
  }

  Ipv4GlobalRoutingHelper::PopulateRoutingTables();

  Simulator::Run();
  Simulator::Destroy();
  return 0;
}
